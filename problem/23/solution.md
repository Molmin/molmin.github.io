容易想到若软件存在依赖关系，就给它们连一条有向边，那么将会形成一个有向图。

接着考虑一种情况：**有向图中存在一个环。**此时必须选择环中的所有软件，这些软件才都可以正常运行。不妨对图进行 **Tarjan 缩点**，缩点后的新点的 $V$ 值和 $W$ 值只需累加即可。考虑到每个软件至多有 $1$ 个依赖软件，故至多有 $n$ 条边，则对于每个连通块，至多存在一个环。

这样每个连通块就变成了一棵树，我们研究这棵树。容易想到**树形动态规划**。

设状态 $dp_{i,\ j}$ 表示对于以 $i$ 为根的子树，安装的软件占用空间不超过 $j$ 时的最大价值。

对于一个新的软件 $u$，初始化如下：

$$
\forall\ i\in[W_u,\ M],\ dp_{u,\ i}\gets V_u.
$$

考虑状态转移。对于 $v$ 是 $u$ 的儿子结点，此时即为一个背包问题：枚举 $j$ 表示不算软件 $v$，之前的软件占用空间上限；再枚举 $k$ 表示以 $v$ 为根的子树占用的空间。易得该情况下价值最大为

$$
dp_{u,\ j+W_v-k}+dp_{v,\ k},
$$

只需用该值更新 $dp_{u,\ j+W_v}$ 即可。

对于**存在多个连通块（树）**的情况，只需令每棵独立树的根节点与一个特殊节点 $0$ 连边，即令所有没有安装依赖的软件依赖软件 $0$，而软件 $0$ 的占用空间和价值都为 $0$。
